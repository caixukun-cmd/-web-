<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å°è½¦æ¨¡æ‹Ÿä»¿çœŸç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
            background: #1e1e1e;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            height: 50px;
        }

        .navbar h1 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .navbar .username {
            font-weight: 500;
            font-size: 14px;
        }

        .navbar .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            padding: 6px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
        }

        .navbar .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            display: flex;
            height: calc(100vh - 50px);
        }

        .left-panel {
            width: 50%;
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #333;
        }

        .editor-header {
            background: #2d2d2d;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e3e;
        }

        .editor-header h3 {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }

        .editor-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            outline: none;
        }

        .btn-run {
            background: #4CAF50;
            color: white;
        }

        .btn-run:hover {
            background: #45a049;
        }

        .btn-run:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #f44336;
            color: white;
        }

        .btn-stop:hover {
            background: #da190b;
        }

        .btn-stop:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-home {
            background: #4caf50;
            color: white;
        }

        .btn-home:hover {
            background: #45a049;
        }

        .btn-home:disabled {
            background: #666;
            cursor: not-allowed;
        }


        select {
            padding: 6px;
            margin-right: 10px;
            background: #2d2d2d;
            color: white;
            border: 1px solid #3e3e3e;
            border-radius: 4px;
            font-size: 13px;
        }

        #editor {
            flex: 1;
            width: 100%;
        }

        .right-panel {
            width: 50%;
            background: #252525;
            display: flex;
            flex-direction: column;
        }

        .canvas-header {
            background: #2d2d2d;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e3e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .canvas-header h3 {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }

        .camera-select {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #ddd;
        }

        #canvas-container {
            flex: 1;
            position: relative;
        }

        .status-bar {
            background: #2d2d2d;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #3e3e3e;
            font-size: 12px;
            color: #aaa;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-indicator.active {
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }

        .console {
            background: #1e1e1e;
            border-top: 2px solid #333;
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #ddd;
        }

        .console-line {
            margin: 2px 0;
            padding: 2px 5px;
        }

        .console-line.error {
            color: #f44336;
        }

        .console-line.info {
            color: #2196F3;
        }

        .console-line.success {
            color: #4CAF50;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ğŸš— æ™ºèƒ½å°è½¦æ¨¡æ‹Ÿä»¿çœŸç³»ç»Ÿ</h1>
        <div class="user-info">
            <span class="username" id="username">åŠ è½½ä¸­...</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="container">
        <!-- å·¦ä¾§ï¼šä»£ç ç¼–è¾‘å™¨ -->
        <div class="left-panel">
            <div class="editor-header">
                <h3>ğŸ’» ä»£ç ç¼–è¾‘å™¨ (Python)</h3>
                <div class="editor-controls">
                    <select id="exampleSelector" onchange="loadExampleCode()" style="padding: 6px; margin-right: 10px; background: #2d2d2d; color: white; border: 1px solid #3e3e3e; border-radius: 4px;">
                        <option value="basic">åŸºæœ¬ç§»åŠ¨æ¼”ç¤º</option>
                        <option value="square">æ–¹å½¢è·¯å¾„æ¼”ç¤º</option>
                        <option value="continuous">è¿ç»­ç§»åŠ¨æ¼”ç¤º</option>
                        <option value="line_follow">è‡ªåŠ¨å¾ªçº¿æ¼”ç¤º</option>
                    </select>
                    <button class="btn btn-run" id="runBtn" onclick="runCode()">â–¶ è¿è¡Œ</button>
                    <button class="btn btn-stop" id="stopBtn" onclick="stopCode()" disabled>â¹ ç»ˆæ­¢</button>
                    <button class="btn btn-home" id="homeBtn" onclick="homeCar()" disabled>ğŸ  å½’ä½</button>
                </div>
            </div>
            <div id="editor"></div>
            <div class="console" id="console">
                <div class="console-line info">æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å°è½¦æ¨¡æ‹Ÿä»¿çœŸç³»ç»Ÿ</div>
                <div class="console-line info">åœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­ç¼–å†™ä»£ç ï¼Œç‚¹å‡»"è¿è¡Œ"æŒ‰é’®æŸ¥çœ‹å°è½¦è¿è¡Œæ•ˆæœ</div>
            </div>
        </div>

        <!-- å³ä¾§ï¼š3Dåœºæ™¯ -->
        <div class="right-panel">
            <div class="canvas-header">
                <h3>ğŸ® 3Dä»¿çœŸåœºæ™¯</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <!-- åœ°å›¾é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                    <div class="map-select" style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #ddd;">
                        <span>åœ°å›¾:</span>
                        <select id="mapSelector" onchange="selectMap(this.value)" title="é€‰æ‹©å¾ªçº¿åœ°å›¾">
                            <option value="">è¯·é€‰æ‹©åœ°å›¾...</option>
                        </select>
                    </div>
                    <!-- è§†è§’é€‰æ‹© -->
                    <div class="camera-select">
                        <span>è§†è§’:</span>
                        <select id="cameraSelector" onchange="setCameraMode(this.value)">
                            <option value="orbit">è‡ªç”±è§†è§’</option>
                            <option value="car_front">è½¦å‰è§†è§’</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="canvas-container">
                <div class="loading">æ­£åœ¨åŠ è½½3Dåœºæ™¯...</div>
            </div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="connectionStatus"></div>
                    <span>è¿æ¥çŠ¶æ€: <span id="connectionText">æœªè¿æ¥</span></span>
                </div>
                <div class="status-item">
                    <span>ä½ç½®: X=<span id="posX">0.00</span> Y=<span id="posY">0.00</span></span>
                </div>
                <div class="status-item">
                    <span>é€Ÿåº¦: <span id="speed">0.00</span> m/s</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js" integrity="" crossorigin="anonymous"></script>
    
    <!-- Three.js - ä½¿ç”¨æ¨¡å—ç‰ˆæœ¬ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/",
            "three/addons/loaders/GLTFLoader.js": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/loaders/GLTFLoader.js"
        }
    }
    </script>

    <script src="/js/auth.js"></script>
    
    <!-- ä»¿çœŸæ ¸å¿ƒé€»è¾‘ -->
    <script type="module">
        import { 
            initScene, 
            connectWebSocket, 
            sendMessage, 
            isWebSocketConnected,
            setCameraMode,
            resetFreeCamera,
            clearPath,
            startPathRecording,
            stopPathRecording
        } from '/js/simulator.js';
        
        // å°†æ¨¡å—å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.initScene = initScene;
        window.connectWebSocket = connectWebSocket;
        window.sendMessage = sendMessage;
        window.isWebSocketConnected = isWebSocketConnected;
        window.setCameraMode = setCameraMode;
        window.resetFreeCamera = resetFreeCamera;
        window.clearPath = clearPath;
        window.startPathRecording = startPathRecording;
        window.stopPathRecording = stopPathRecording;
    </script>
    <script>
        let editor;
        let wsConnection = null;  // å­˜å‚¨WebSocketè¿æ¥
        let isRunning = false;

        // æš´éœ²å…¨å±€å‡½æ•°ç»™HTML
        window.runCode = runCode;
        window.stopCode = stopCode;
        window.homeCar = homeCar;
        window.handleLogout = handleLogout;
        window.loadExampleCode = loadExampleCode;
        window.selectMap = selectMap;  // æ–°å¢ï¼šåœ°å›¾é€‰æ‹©å‡½æ•°

        // å½“å‰é€‰ä¸­çš„åœ°å›¾ID
        let currentMapId = null;

        // é»˜è®¤ç¤ºä¾‹ä»£ç 
        const defaultCode = '# åŸºæœ¬ç§»åŠ¨æ¼”ç¤º\n' +
                            'print("=== åŸºæœ¬ç§»åŠ¨æ¼”ç¤º ===")\n' +
                            'print("åˆå§‹ä½ç½®:", car.get_position())\n' +
                            '\n' +
                            'print("å‰è¿›æ¼”ç¤ºå¼€å§‹...")\n' +
                            'car.forward(80, 4.0)\n' +
                            'await car.wait()  # ç­‰å¾…å®Œæˆ\n' +
                            'print("å‰è¿›å®Œæˆï¼Œä½ç½®:", car.get_position())\n' +
                            '\n' +
                            'await time.sleep(1)\n' +
                            '\n' +
                            'print("åé€€æ¼”ç¤ºå¼€å§‹...")\n' +
                            'car.backward(80, 4.0)\n' +
                            'await car.wait()\n' +
                            'print("åé€€å®Œæˆï¼Œä½ç½®:", car.get_position())\n' +
                            '\n' +
                            'await time.sleep(1)\n' +
                            '\n' +
                            'print("è½¬å‘æ¼”ç¤ºå¼€å§‹...")\n' +
                            'car.turn_right(90)\n' +
                            'await time.sleep(1)\n' +
                            'car.turn_left(45)\n' +
                            'await time.sleep(1)\n' +
                            'print("è½¬å‘å®Œæˆï¼Œä½ç½®:", car.get_position())\n' +
                            '\n' +
                            'print("æ¼”ç¤ºç»“æŸï¼Œæœ€ç»ˆä½ç½®:", car.get_position())';

        // åˆå§‹åŒ–Monaco Editor
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: defaultCode,
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: true },
                scrollBeyondLastLine: false,
                lineNumbers: 'on',
                roundedSelection: false,
                readOnly: false,
                cursorStyle: 'line'
            });
            
            // è®¾ç½®åŸºæœ¬ç§»åŠ¨æ¼”ç¤ºä¸ºé»˜è®¤é€‰æ‹©
            if (document.getElementById('exampleSelector')) {
                document.getElementById('exampleSelector').value = 'basic';
            }
        });

        // åˆå§‹åŒ–Three.jsåœºæ™¯
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            if (window.initScene) {
                initScene(container);
                addConsoleLog('3Dåœºæ™¯åˆå§‹åŒ–å®Œæˆ', 'success');
            } else {
                console.error('initScene å‡½æ•°æœªå®šä¹‰');
                addConsoleLog('3Dåœºæ™¯åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„æœåŠ¡å™¨åœ°å€å’Œç«¯å£
            const host = window.location.hostname || 'localhost';
            // å¼ºåˆ¶ä½¿ç”¨FastAPIåç«¯ç«¯å£8000ï¼Œè€Œä¸æ˜¯å‰ç«¯æœåŠ¡å™¨ç«¯å£
            const port = '8000';
            const wsUrl = `${protocol}//${host}:${port}/ws`;
            
            wsConnection = connectWebSocket(wsUrl, {
                onOpen: () => {
                    updateConnectionStatus(true);
                    addConsoleLog('WebSocketè¿æ¥æˆåŠŸ', 'success');
                },
                onStatus: (data) => {
                    updateStatus(data);
                },
                onLog: (message, level) => {
                    addConsoleLog(message, level);
                },
                onError: (error) => {
                    updateConnectionStatus(false);
                    addConsoleLog('WebSocketè¿æ¥é”™è¯¯: ' + error, 'error');
                    // é‡ç½®è¿è¡ŒçŠ¶æ€ï¼Œç¡®ä¿æŒ‰é’®å¯ç”¨
                    isRunning = false;
                    document.getElementById('runBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('homeBtn').disabled = false;  // æš‚åœçŠ¶æ€ä¸‹å¯ç”¨å½’ä½æŒ‰é’®
                },
                onClose: () => {
                    updateConnectionStatus(false);
                    addConsoleLog('WebSocketè¿æ¥å·²å…³é—­', 'info');
                    // é‡ç½®è¿è¡ŒçŠ¶æ€ï¼Œç¡®ä¿æŒ‰é’®å¯ç”¨
                    isRunning = false;
                    document.getElementById('runBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('homeBtn').disabled = false;  // æš‚åœçŠ¶æ€ä¸‹å¯ç”¨å½’ä½æŒ‰é’®
                },
                onComplete: (message) => {
                    addConsoleLog(message, 'success');
                    stopCode();
                },
                // æ–°å¢ï¼šåœ°å›¾åˆ—è¡¨å›è°ƒ
                onMapsList: (maps) => {
                    populateMapSelector(maps);
                },
                // æ–°å¢ï¼šè½¨é“åŠ è½½å®Œæˆå›è°ƒ
                onTrackLoaded: (trackData) => {
                    addConsoleLog(`è½¨é“å·²åŠ è½½: ${trackData.name || trackData._mapId}`, 'success');
                }
            });
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.classList.add('active');
                text.textContent = 'å·²è¿æ¥';
                // è¿æ¥æˆåŠŸåè¯·æ±‚åœ°å›¾åˆ—è¡¨
                requestMapsList();
            } else {
                indicator.classList.remove('active');
                text.textContent = 'æœªè¿æ¥';
            }
        }

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        function updateStatus(data) {
            if (data.speed !== undefined) {
                document.getElementById('speed').textContent = data.speed.toFixed(2);
            }
            if (data.x !== undefined && data.y !== undefined) {
                document.getElementById('posX').textContent = data.x.toFixed(2);
                document.getElementById('posY').textContent = data.y.toFixed(2);
            }
        }

        // æ·»åŠ æ§åˆ¶å°æ—¥å¿—
        function addConsoleLog(message, type = 'info') {
            const consoleEl = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // è¿è¡Œä»£ç 
        function runCode() {
            if (!editor) {
                addConsoleLog('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            const code = editor.getValue();
            if (!code.trim()) {
                addConsoleLog('è¯·è¾“å…¥ä»£ç ', 'error');
                return;
            }

            if (!isWebSocketConnected()) {
                addConsoleLog('WebSocketæœªè¿æ¥ï¼Œæ­£åœ¨é‡æ–°è¿æ¥...', 'info');
                initWebSocket();
                
                // ç­‰å¾…è¿æ¥å»ºç«‹åå†è¿è¡Œä»£ç 
                const checkConnection = setInterval(() => {
                    if (isWebSocketConnected()) {
                        clearInterval(checkConnection);
                        addConsoleLog('WebSocketè¿æ¥å·²å»ºç«‹ï¼Œå¼€å§‹æ‰§è¡Œä»£ç ...', 'success');
                        
                        // é‡æ–°æ£€æŸ¥ç¼–è¾‘å™¨çŠ¶æ€å¹¶æ‰§è¡Œä»£ç 
                        if (!editor) {
                            addConsoleLog('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                            return;
                        }
                        
                        const code = editor.getValue();
                        if (!code.trim()) {
                            addConsoleLog('è¯·è¾“å…¥ä»£ç ', 'error');
                            return;
                        }
                        
                        isRunning = true;
                        document.getElementById('runBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                        document.getElementById('homeBtn').disabled = true;  // è¿è¡Œæ—¶ç¦ç”¨å½’ä½æŒ‰é’®
                        document.getElementById('mapSelector').disabled = true;  // è¿è¡Œæ—¶é”å®šåœ°å›¾é€‰æ‹©
                        
                        // å¼€å¯è·¯å¾„è®°å½•å™¨
                        if (window.startPathRecording) {
                            window.startPathRecording();
                        }
                        
                        addConsoleLog('å¼€å§‹æ‰§è¡Œä»£ç ...', 'info');
                        
                        sendMessage({
                            type: 'run_code',
                            code: code
                        });
                    }
                }, 100); // æ¯100msæ£€æŸ¥ä¸€æ¬¡è¿æ¥çŠ¶æ€
                
                // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢æ— é™ç­‰å¾…
                setTimeout(() => {
                    clearInterval(checkConnection);
                    if (!isWebSocketConnected()) {
                        addConsoleLog('é‡æ–°è¿æ¥è¶…æ—¶ï¼Œæ— æ³•è¿è¡Œä»£ç ', 'error');
                    }
                }, 5000); // 5ç§’è¶…æ—¶
                return;
            }

            isRunning = true;
            document.getElementById('runBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('homeBtn').disabled = true;  // è¿è¡Œæ—¶ç¦ç”¨å½’ä½æŒ‰é’®
            document.getElementById('mapSelector').disabled = true;  // è¿è¡Œæ—¶é”å®šåœ°å›¾é€‰æ‹©

            // å¼€å¯è·¯å¾„è®°å½•å™¨
            if (window.startPathRecording) {
                window.startPathRecording();
            }

            addConsoleLog('å¼€å§‹æ‰§è¡Œä»£ç ...', 'info');
            
            sendMessage({
                type: 'run_code',
                code: code
            });
        }

        // åœæ­¢ä»£ç 
        function stopCode() {
            if (isWebSocketConnected()) {
                sendMessage({ type: 'stop' });
            }

            isRunning = false;
            document.getElementById('runBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('homeBtn').disabled = false;  // æš‚åœçŠ¶æ€ä¸‹å¯ç”¨å½’ä½æŒ‰é’®
            document.getElementById('mapSelector').disabled = false;  // åœæ­¢æ—¶è§£é”åœ°å›¾é€‰æ‹©
            
            // å…³é—­è·¯å¾„è®°å½•å™¨
            if (window.stopPathRecording) {
                window.stopPathRecording();
            }
            
            addConsoleLog('å·²åœæ­¢æ‰§è¡Œ', 'info');
        }

        // å½’ä½åŠŸèƒ½
        function homeCar() {
            if (!isWebSocketConnected()) {
                addConsoleLog('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å½’ä½', 'error');
                return;
            }

            if (isRunning) {
                addConsoleLog('è¯·å…ˆåœæ­¢ä»£ç æ‰§è¡Œåå†å½’ä½', 'warning');
                return;
            }

            // å‘é€å½’ä½æ¶ˆæ¯åˆ°åç«¯ï¼ˆå°è½¦å½’ä½ï¼‰
            sendMessage({ type: 'home' });
            
            // åŒæ—¶é‡ç½®è‡ªç”±è§†è§’ç›¸æœºåˆ°åˆå§‹ä½ç½®
            if (window.resetFreeCamera) {
                window.resetFreeCamera();
            }
            
            // å½’ä½å®Œæˆåç¦ç”¨æŒ‰é’®
            document.getElementById('homeBtn').disabled = true;
            
            addConsoleLog('å½’ä½å®Œæˆ', 'success');
        }

        // ===== åœ°å›¾é€‰æ‹©åŠŸèƒ½ =====
        
        // è¯·æ±‚åœ°å›¾åˆ—è¡¨
        function requestMapsList() {
            if (isWebSocketConnected()) {
                sendMessage({ type: 'get_maps' });
            }
        }
        
        // å¡«å……åœ°å›¾ä¸‹æ‹‰æ¡†
        function populateMapSelector(maps) {
            const selector = document.getElementById('mapSelector');
            if (!selector) return;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªæç¤ºé€‰é¡¹ï¼‰
            selector.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°å›¾...</option>';
            
            // æ·»åŠ åœ°å›¾é€‰é¡¹
            maps.forEach(map => {
                if (map.available) {
                    const option = document.createElement('option');
                    option.value = map.id;
                    option.textContent = map.name;
                    option.title = map.description;  // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæè¿°
                    selector.appendChild(option);
                }
            });
            
            // å¦‚æœä¹‹å‰é€‰ä¸­äº†åœ°å›¾ï¼Œæ¢å¤é€‰ä¸­çŠ¶æ€
            if (currentMapId) {
                selector.value = currentMapId;
            }
            
            addConsoleLog(`å·²åŠ è½½ ${maps.filter(m => m.available).length} ä¸ªå¯ç”¨åœ°å›¾`, 'info');
        }
        
        // é€‰æ‹©åœ°å›¾
        function selectMap(mapId) {
            if (!mapId) {
                currentMapId = null;
                return;
            }
            
            // è¿è¡Œæ—¶ç¦æ­¢æ›´æ¢åœ°å›¾
            if (isRunning) {
                addConsoleLog('ä»£ç æ‰§è¡Œä¸­ï¼Œæ— æ³•æ›´æ¢åœ°å›¾', 'warning');
                // æ¢å¤ä¸‹æ‹‰æ¡†åˆ°ä¹‹å‰çš„é€‰é¡¹
                const selector = document.getElementById('mapSelector');
                if (selector) selector.value = currentMapId || '';
                return;
            }
            
            if (!isWebSocketConnected()) {
                addConsoleLog('WebSocketæœªè¿æ¥ï¼Œæ— æ³•åŠ è½½åœ°å›¾', 'error');
                return;
            }
            
            currentMapId = mapId;
            addConsoleLog(`æ­£åœ¨åŠ è½½åœ°å›¾: ${mapId}...`, 'info');
            
            // å‘é€åœ°å›¾é€‰æ‹©æ¶ˆæ¯åˆ°åç«¯
            sendMessage({
                type: 'select_map',
                mapId: mapId
            });
        }


        // åŠ è½½ç¤ºä¾‹ä»£ç 
        function loadExampleCode() {
            const exampleType = document.getElementById('exampleSelector').value;
            let code = '';
            
            switch(exampleType) {
                case 'basic':
                    code = '# åŸºæœ¬ç§»åŠ¨æ¼”ç¤º - çªå‡ºæ˜¾ç¤ºç§»åŠ¨å’Œè½¬å‘\n' +
                           'print("=== åŸºæœ¬ç§»åŠ¨æ¼”ç¤º ===")\n' +
                           'print("åˆå§‹ä½ç½®:", car.get_position())\n' +
                           '\n' +
                           '# æ˜æ˜¾çš„å‰è¿›åŠ¨ä½œï¼Œä¾¿äºè§‚å¯Ÿç§»åŠ¨\n' +
                           'print("å‰è¿›æ¼”ç¤ºå¼€å§‹...")\n' +
                           'car.forward(80, 4.0)  # å‰è¿›80çš„é€Ÿåº¦ï¼ŒæŒç»­4ç§’\n' +
                           'car.wait()  # ç­‰å¾…è¿åŠ¨å®Œæˆ\n' +
                           'car.stop()\n' +
                           'print("å‰è¿›å®Œæˆï¼Œä½ç½®:", car.get_position())\n' +
                           '\n' +
                           'time.sleep(1)  # çŸ­æš‚åœé¡¿\n' +
                           '\n' +
                           '# æ˜æ˜¾çš„åé€€åŠ¨ä½œ\n' +
                           'print("åé€€æ¼”ç¤ºå¼€å§‹...")\n' +
                           'car.backward(80, 4.0)  # åé€€80çš„é€Ÿåº¦ï¼ŒæŒç»­4ç§’\n' +
                           'await car.wait()  # ç­‰å¾…è¿åŠ¨å®Œæˆ\n' +
                           'car.stop()\n' +
                           'print("åé€€å®Œæˆï¼Œä½ç½®:", car.get_position())\n' +
                           '\n' +
                           'time.sleep(1)  # çŸ­æš‚åœé¡¿\n' +
                           '\n' +
                           '# è½¬å‘æ¼”ç¤º - ç¬æ—¶æ•ˆæœï¼Œå®¹æ˜“è§‚å¯Ÿ\n' +
                           'print("è½¬å‘æ¼”ç¤ºå¼€å§‹...")\n' +
                           'car.turn_right(90)\n' +
                           'time.sleep(1)  # è½¬å‘æ˜¯ç¬æ—¶çš„ï¼Œæ‰€ä»¥æ—¶é—´è¾ƒçŸ­\n' +
                           'car.turn_left(45)\n' +
                           'time.sleep(1)\n' +
                           'print("è½¬å‘å®Œæˆï¼Œä½ç½®:", car.get_position())\n' +
                           '\n' +
                           'car.stop()\n' +
                           'print("æ¼”ç¤ºç»“æŸï¼Œæœ€ç»ˆä½ç½®:", car.get_position())';
                    break;
                case 'square':
                    code = '# æ–¹å½¢è·¯å¾„æ¼”ç¤º\n' +
                           'print("=== æ–¹å½¢è·¯å¾„æ¼”ç¤º ===")\n' +
                           '\n' +
                           'for i in range(4):\n' +
                           '    print(f"ç¬¬{i+1}è¾¹: å‰è¿›2ç§’...")\n' +
                           '    car.forward(70, 2.0)  # å‰è¿›70çš„é€Ÿåº¦ï¼ŒæŒç»­2ç§’\n' +
                           '    await car.wait()  # ç­‰å¾…è¿åŠ¨å®Œæˆ\n' +
                           '    await time.sleep(0.5)  # çŸ­æš‚åœé¡¿\n' +
                           '    print(f"ç¬¬{i+1}æ¬¡å³è½¬...")\n' +
                           '    car.turn_right(90)\n' +
                           '    await time.sleep(1)  # è½¬å‘ååœé¡¿\n' +
                           '    print(f"ç¬¬{i+1}è¾¹å®Œæˆåä½ç½®:", car.get_position())\n' +
                           '\n' +
                           'print("æ–¹å½¢è·¯å¾„å®Œæˆï¼Œæœ€ç»ˆä½ç½®:", car.get_position())';
                    break;
                case 'continuous':
                    code = '# è¿ç»­ç§»åŠ¨æ¼”ç¤º\n' +
                           'print("=== è¿ç»­ç§»åŠ¨æ¼”ç¤º ===")\n' +
                           '\n' +
                           'directions = [\n' +
                           '    (80, 3, "å‰è¿›3ç§’"), \n' +
                            '    (-80, 3, "åé€€3ç§’"), \n' +
                           '    (0, 0, "å³è½¬90åº¦"), \n' +
                           '    (80, 2, "å‰è¿›2ç§’"), \n' +
                           '    (0, 0, "å·¦è½¬45åº¦"), \n' +
                           '    (80, 3, "å‰è¿›3ç§’")\n' +
                           ']\n' +
                           '\n' +
                           'for speed, duration, action in directions:\n' +
                           '    if "è½¬" in action:\n' +
                           '        if "å³" in action:\n' +
                           '            car.turn_right(90)\n' +
                           '        else:\n' +
                           '            car.turn_left(45)\n' +
                           '        await time.sleep(1)  # è½¬å‘ååœé¡¿\n' +
                           '    else:\n' +
                           '        if speed > 0:\n' +
                           '            car.forward(speed, duration)\n' +
                           '        elif speed < 0:\n' +
                           '            car.backward(abs(speed), duration)\n' +
                           '        await car.wait()  # ç­‰å¾…è¿åŠ¨å®Œæˆ\n' +
                           '    print(f"æ‰§è¡Œ: {action}, ä½ç½®: {car.get_position()}")\n' +
                           '\n' +
                           'print("è¿ç»­ç§»åŠ¨å®Œæˆï¼Œæœ€ç»ˆä½ç½®:", car.get_position())';
                    break;
                case 'line_follow':
                    code = '# è‡ªåŠ¨å¾ªçº¿æ¼”ç¤º\n' +
                        '# æœ¬æ¼”ç¤ºå±•ç¤ºå¦‚ä½•ä½¿ç”¨å¾ªçº¿ç³»ç»Ÿ API\n' +
                        'print("=== è‡ªåŠ¨å¾ªçº¿æ¼”ç¤º ===")\n' +
                        '\n' +
                        '# 1. åŠ è½½æ¼”ç¤ºè½¨é“\n' +
                        'print("æ­¥éª¤1: åŠ è½½æ¼”ç¤ºè½¨é“...")\n' +
                        'await car.load_demo_track()\n' +
                        'await time.sleep(1)  # ç­‰å¾…è½¨é“åŠ è½½\n' +
                        '\n' +
                        '# 2. åˆå§‹åŒ–å¾ªçº¿ç³»ç»Ÿ\n' +
                        'print("æ­¥éª¤2: åˆå§‹åŒ–å¾ªçº¿ç³»ç»Ÿ...")\n' +
                        'await car.init_line_following()\n' +
                        'await time.sleep(0.5)\n' +
                        '\n' +
                        '# 3. å¯ç”¨å¾ªçº¿åŠŸèƒ½ï¼ˆè®¾ç½® PID å‚æ•°ï¼‰\n' +
                        '# å‚æ•°è¯´æ˜: kp=æ¯”ä¾‹ç³»æ•°, ki=ç§¯åˆ†ç³»æ•°, kd=å¾®åˆ†ç³»æ•°, steering_scale=è½¬å‘ç¼©æ”¾\n' +
                        'print("æ­¥éª¤3: å¯ç”¨å¾ªçº¿åŠŸèƒ½ (PID: Kp=1.0, Ki=0.0, Kd=0.1)...")\n' +
                        'await car.enable_line_following(kp=1.0, ki=0.0, kd=0.1, steering_scale=45.0)\n' +
                        'await time.sleep(0.5)\n' +
                        '\n' +
                        '# 4. å°è½¦å‰è¿›ï¼Œå¾ªçº¿ç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒæ•´æ–¹å‘\n' +
                        'print("æ­¥éª¤4: å°è½¦å¼€å§‹å¾ªçº¿è¡Œé©¶...")\n' +
                        'print("æç¤º: å¾ªçº¿ç³»ç»Ÿä¼šæ ¹æ®æ¢å¤´è¯»æ•°è‡ªåŠ¨è°ƒæ•´è½¬å‘")\n' +
                        'car.forward(50, 50.0)  # ä»¥50é€Ÿåº¦å‰è¿›10ç§’\n' +
                        'await car.wait()\n' +
                        '\n' +
                        '# 5. åœæ­¢å¹¶ç¦ç”¨å¾ªçº¿\n' +
                        'print("æ­¥éª¤5: ç¦ç”¨å¾ªçº¿åŠŸèƒ½...")\n' +
                        'await car.disable_line_following()\n' +
                        'car.stop()\n' +
                        '\n' +
                        'print("å¾ªçº¿æ¼”ç¤ºå®Œæˆï¼Œæœ€ç»ˆä½ç½®:", car.get_position())\n' +
                        '\n' + "# ===== å¾ªçº¿ API å‚è€ƒ =====\n# car.load_demo_track()         - åŠ è½½æ¼”ç¤ºè½¨é“\n# car.load_track_url(url)       - ä» URL åŠ è½½è½¨é“\n" +
                           '# car.init_line_following()     - åˆå§‹åŒ–å¾ªçº¿ç³»ç»Ÿ\n' +
                           '# car.enable_line_following(kp, ki, kd, scale) - å¯ç”¨å¾ªçº¿\n' +
                           '# car.disable_line_following()  - ç¦ç”¨å¾ªçº¿\n' +
                           '# car.set_line_pid(kp, ki, kd)  - åŠ¨æ€è°ƒæ•´ PID\n' +
                           '# car.set_steering_scale(scale) - è°ƒæ•´è½¬å‘ç¼©æ”¾';
                    break;
                default:
                    code = defaultCode;
            }
            
            if (editor) {
                editor.setValue(code);
            }
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    // å¼€å‘æ¨¡å¼ï¼šå…è®¸æ— éœ€ç™»å½•
                    document.getElementById('username').textContent = 'è®¿å®¢ç”¨æˆ·';
                    return;
                }

                const user = await getCurrentUser();
                if (user) {
                    document.getElementById('username').textContent = user.username;
                } else {
                    // å¦‚æœè·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä»ç„¶å…è®¸è®¿é—®
                    document.getElementById('username').textContent = 'è®¿å®¢ç”¨æˆ·';
                }
            } catch (error) {
                console.log('è®¤è¯æ£€æŸ¥å¤±è´¥ï¼Œä½¿ç”¨è®¿å®¢æ¨¡å¼:', error);
                document.getElementById('username').textContent = 'è®¿å®¢ç”¨æˆ·';
            }
        }

        // é€€å‡ºç™»å½•
        function handleLogout() {
            if (wsConnection) {
                wsConnection.close();
            }
            try {
                logout();
            } catch (error) {
                console.log('ç™»å‡ºå¤±è´¥:', error);
            }
            window.location.href = 'login.html';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ¨¡å—å·²åŠ è½½
            setTimeout(() => {
                initThreeJS();
                // ç«‹å³åˆå§‹åŒ–WebSocketè¿æ¥
                initWebSocket();
            }, 100);
        });

        // é¡µé¢å¸è½½æ—¶å…³é—­WebSocket
        window.addEventListener('beforeunload', () => {
            if (wsConnection) {
                wsConnection.close();
            }
        });
    </script>
</body>
</html>
